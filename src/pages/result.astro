---
import Layout from '../layouts/layout.astro';
import { kv } from "@vercel/kv";

const token = Astro.url.searchParams.get('t');

if (!token) {
  return Astro.redirect('/');
}

const resultData = await kv.get<{ purchaseToken: string; thumbnailUrl: string | null }>(`result:${token}`);

if (!resultData || !resultData.purchaseToken) {
  return Astro.redirect('/');
}

const { purchaseToken, thumbnailUrl } = resultData;
---

<Layout title="Muotokuvasi - Lemmikkistudio">
  <main class="min-h-screen flex flex-col items-center justify-center p-4 bg-[#001121]">
    <div class="bg-white p-8 rounded-[28px] shadow-lg max-w-lg w-full text-center space-y-6">
      <h1 class="text-2xl font-bold text-gray-900">Muotokuvasi on valmis</h1>
      <p class="text-gray-600">Osta vesileimaton kuva ja lataa se itsellesi.</p>

      <div class="rounded-xl overflow-hidden shadow-lg border-4 border-white my-4">
        <img src={purchaseToken} alt="Generoitu muotokuva" class="w-full h-auto" />
      </div>

      <button
        id="buy-btn"
        type="button"
        class="w-full py-4 bg-violet-600 text-white text-center rounded-full font-medium hover:bg-violet-700 transition shadow-md hover:shadow-lg flex items-center justify-center gap-2 cursor-pointer disabled:opacity-70 disabled:cursor-not-allowed"
      >
        <span id="buy-btn-text">Osta nyt – 4,90 €</span>
      </button>
      <p class="text-xs text-gray-500">
        <span class="line-through">Norm. hinta 7,90€</span>
      </p>
      <p class="text-xs text-gray-400">
        Saat täysikokoisen, vesileimattoman kuvan heti maksun jälkeen.
      </p>

      <a href="/" class="block text-sm text-gray-500 hover:text-gray-700 mt-4">
        ← Luo uusi kuva
      </a>
    </div>
  </main>

  <script define:vars={{ purchaseToken, thumbnailUrl }}>
    const btn = document.getElementById('buy-btn');
    const btnText = document.getElementById('buy-btn-text');
    if (btn && btnText) {
      btn.addEventListener('click', async () => {
        btn.disabled = true;
        btnText.textContent = 'Avataan kassaa...';
        try {
          const res = await fetch('/api/create-checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              imageUrl: purchaseToken,
              thumbnailUrl: thumbnailUrl || undefined,
            }),
          });
          const data = await res.json();
          if (data.url) {
            window.location.href = data.url;
          } else {
            alert(data.error || 'Maksusivun avaus epäonnistui');
            btn.disabled = false;
            btnText.textContent = 'Osta nyt – 4,90 €';
          }
        } catch (err) {
          console.error(err);
          alert('Jotain meni pieleen. Yritä uudestaan.');
          btn.disabled = false;
          btnText.textContent = 'Osta nyt – 4,90 €';
        }
      });
    }
  </script>
</Layout>
