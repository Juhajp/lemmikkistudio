---
// src/components/CookieConsent.astro
// Korvaa t√§m√§ omalla Pixel ID:ll√§si!
const META_PIXEL_ID = "SINUN_PIXEL_ID_TAHAN";
---

<div id="cookie-banner" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] p-4 md:p-6 z-50 hidden flex-col md:flex-row items-center justify-between gap-4 transition-transform duration-300 translate-y-full">
  <div class="text-sm text-gray-700 max-w-2xl">
    <p class="font-bold mb-1">K√§yt√§mme ev√§steit√§ üç™</p>
    <p>
      K√§yt√§mme sivustolla v√§ltt√§m√§tt√∂mi√§ ev√§steit√§ sek√§ Metan markkinointiev√§steit√§ mainonnan kohdentamiseen. 
      Hyv√§ksym√§ll√§ annat luvan Meta Pixelin lataamiseen.
      <a href="/tietosuoja" class="underline text-blue-600 hover:text-blue-800">Lue tietosuojaseloste.</a>
    </p>
  </div>
  <div class="flex gap-3 shrink-0">
    <button id="cookie-reject" class="px-4 py-2 text-sm font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
      Vain v√§ltt√§m√§tt√∂m√§t
    </button>
    <button id="cookie-accept" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-sm transition-colors">
      Hyv√§ksy kaikki
    </button>
  </div>
</div>

<script define:vars={{ META_PIXEL_ID }}>
  // 1. M√§√§ritell√§√§n funktio, joka lataa Meta Pixelin
  function loadMetaPixel() {
    console.log("Meta Pixel loaded with Consent ‚úÖ");
    
    // Meta Pixel Base Code
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    
    fbq('init', META_PIXEL_ID);
    fbq('track', 'PageView');
  }

  // 2. Tarkistetaan onko lupa jo annettu
  const banner = document.getElementById('cookie-banner');
  const acceptBtn = document.getElementById('cookie-accept');
  const rejectBtn = document.getElementById('cookie-reject');

  const consent = localStorage.getItem('cookie-consent');

  if (consent === 'granted') {
    // Jos lupa on jo, ladataan Pixel heti
    loadMetaPixel();
  } else if (consent === 'denied') {
    // Jos kielletty, ei tehd√§ mit√§√§n (Pixel ei lataudu)
  } else {
    // Jos ei valintaa, n√§ytet√§√§n banneri pienell√§ viiveell√§ (tyylik√§s slide-in)
    banner.classList.remove('hidden');
    setTimeout(() => {
      banner.classList.remove('translate-y-full');
    }, 100);
  }

  // 3. Napink√§sittelij√§t
  acceptBtn.addEventListener('click', () => {
    localStorage.setItem('cookie-consent', 'granted');
    loadMetaPixel(); // K√§ynnist√§ Pixel heti
    hideBanner();
  });

  rejectBtn.addEventListener('click', () => {
    localStorage.setItem('cookie-consent', 'denied');
    // Ei ladata Pixeli√§
    hideBanner();
  });

  function hideBanner() {
    banner.classList.add('translate-y-full');
    setTimeout(() => {
      banner.classList.add('hidden');
    }, 300);
  }
</script>